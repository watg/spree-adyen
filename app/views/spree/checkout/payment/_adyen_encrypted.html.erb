<div id="adyen-encrypted-form">
  <%= image_tag 'credit_cards/credit_card.jpg', :id => 'credit-card-image' %>

  <p class="field">
    <label for="adyen-encrypted-form-holder-name"><%= Spree.t(:name_on_card) %></label><span class="required">*</span><br />
    <input type="text" size="20" value="<%= "#{@order.billing_firstname} #{@order.billing_lastname}" %>" autocomplete="off" data-encrypted-name="holderName" />
  </p>

  <p class="field">
    <label for="adyen-encrypted-form-number"><%= Spree.t(:card_number) %></label><span class="required">*</span><br />
    <input type="text" class="required cardNumber" size="19" autocomplete="off" data-encrypted-name="number" />
    &nbsp;
    <span id="card_type" style="display:none;">
      ( <span id="looks_like" ><%= Spree.t(:card_type_is) %> <span id="type"></span></span>
        <span id="unrecognized"><%= Spree.t(:unrecognized_card_type) %></span>
      )
    </span>
  </p>

  <p class="field">
    <%= label_tag "card_expiry", Spree.t(:expiration) %><span class="required">*</span><br />
    <%= select_month(Date.today, { field_name: 'month', use_two_digit_numbers: true }, class: 'required card-expiry', :'data-encrypted-name' => 'expiryMonth', id: "expiry-month", name: "") %>
    <%= select_year(Date.today, { field_name: 'year', start_year: Date.today.year, end_year: Date.today.year + 15 }, class: 'required card-expiry', :'data-encrypted-name' => 'expiryYear', id: "expiry-year", name: "") %>
  </p>

  <p class="field">
    <label for="adyen-encrypted-form-number"><%= Spree.t(:card_code) %></label><span class="required">*</span><br />
    <input type="<% unless mobile_device? %>text<% else %>number<% end %>" size="4" autocomplete="off" data-encrypted-name="cvc" />
    <%= link_to "(#{Spree.t(:what_is_this)})", spree.content_path('cvv'), :target => '_blank', "data-hook" => "cvv_link", :id => "cvv_link" %>
  </p>

  <input type="hidden" id="adyen-encrypted-form-expiry-generationtime" value="<%= DateTime.current() %>" data-encrypted-name="generationtime" />
</div>

<%= javascript_include_tag "adyen.encrypt.js" %>

<script>    
   // the form will be encrypted before it is submitted
   // This has to be loaded after the dom is ready
   var setCreateEncryptedForm = function(e) {
     var form = document.getElementById('checkout_form_payment');    
     var key = "<%= payment_method.options[:public_key] %>";
     var options = {
       'name': "<%= "payment_source[#{payment_method.id}][encrypted_data]" %>"
     }; 
     adyen.encrypt.createEncryptedForm(form, key, options);
   }

  document.addEventListener("DOMContentLoaded", setCreateEncryptedForm);
  document.addEventListener("page:load", setCreateEncryptedForm);
</script>
